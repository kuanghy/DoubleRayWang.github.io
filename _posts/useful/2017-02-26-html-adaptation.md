---
layout: post
title: "H5 移动多终端适配"
date: 2017-02-26 13:13:05 +0800
categories: 干货分享
tag: HTML
---

* content
{:toc}

　　移动端的浏览器在展示页面时会出现许多非预期的现象，比如有的可能浏览器自动缩放网页让整个内容能够在可视区域展示，但内容会缩小；有的可能会出现横向滚动条。这些都不是理想的浏览状态，理想的网页展示应该是用户进入页面不需要手动缩放就能够看清页面的内容也没有横向滚动条。

　　要如何去实现移动端网页展示达到理想效果涉及到很多因素，但主要包括三个方面：像素（pixels）、屏幕（screen）、视口（viewport）和缩放（scale）。<!-- more -->

## 1. 像素（pixels）

　　像素这个词对绝大多素人都不陌生，正常的理解就是像素就好像是一个个“点”，屏幕由不同数量的点排列构成不同的分辨率，一张图片由不同的像素点构成不同的大小。同时我们经常将像素说成长度的单位，但实际上我们说1像素其实是一个1 x 1的小方块，它的面积是1。

### 1.1 设备像素

　　设备像素又称物理像素，是显示设备（PC、手机显示屏等）最小的物理部件，设备像素由操作系统控制来发光填色值，来让我们在视觉上看到相应的效果（如50 x 50的红色方块）。设备像素做为物理属性的存在是固定不变的，开发人员不可能通过程序控制设备像素数量上的增加减少。

### 1.2 CSS 像素

　　我们平时写网页的时候用的长度单位是 px，属于 CSS 像素。CSS 像素是抽象的，抽象意味着它没有物理属性的实体依据，它可以收缩放大。简单的理解为 CSS 像素点是有面积的，一个个 CSS 像素点铺起来盖在设备的显示屏上，其面积随着浏览器的缩放比例而同步缩放。例如在 PC 上的浏览器中，定义一 100 x 100 的红色方块，缩放比例为 100% 的情况下，一个 CSS 像素是与一个设备像素完全重叠的。当缩放比设置为 50% 即缩小一半，CSS像素会等比缩放一半，那一个 CSS 像素的面积就只占 100% 情况下的四分之一了，所以视觉上看到方块变成了 50x50 的大小（即占了 50x50 的设备像素）。

> **此时浏览器中检查元素大小会发现红色方块的大小仍旧为100x100，只是CSS像素的面积缩小了！**

　　但是，到了移动终端，由于高密度显示技术出现，比如苹果的Retina显示屏中，当缩放比是 100% 的时候，一个 CSS 像素占的面积是 4 个设备像素的面积，即一个 CSS 像素横向宽度覆盖了 2 个设备像素的宽度。缩放比为 100% 时一个 CSS 像素占多少个设备像素是由 **设备像素比（dpr）** 决定的，dpr为 2，则占两个，dpr 为 3 则占三个。dpr 的取值可以通过如下代码得到：

```js
window.devicePixelRatio
```

## 2. 屏幕（screen）

　　屏幕的完整大小用设备像素来衡量，单位是物理属性的单位，做开发的时候也不需要太过关注，我们关注的是CSS像素。一般就可以理解为这个单位和CSS像素的大小在缩放比为100%时是一样大的。我们可以在chrome这类下载浏览器中能够通过`screen.width/height`来得到屏幕高宽的具体值。这个时候你会发现在PC上不管把浏览器窗口调整至多大,返回值总是一致的，移动端上的情况也很明朗，比如iphone6返回的值就是 375。

　　我们构建网页的时候关注的是 CSS 像素，用户看网页的时候关注的是浏览器宽度内的内容，浏览器宽度决定了用户在视觉上能够看到多少东西。所以我们开发的时候关注的也就是浏览器视觉宽度下，里面的 CSS 像素的数量多少。这个浏览器尺寸内的 CSS 像素多少可以通过`window.innerWidth/Height`来获取。由于 CSS 像素会缩放，所以同一个浏览器宽度下这个取值是可能不同的。

## 3. 视口（viewport）

　　我们进行网页布局的时候设置 html 元素宽度为100%，这个100%是依据什么设置的呢？浏览器窗口用 CSS 像素衡量的宽度（`window.innerWidth`)还是别的呢？我们可以发现在PC端的浏览器上设置100%，html 元素的 px 宽度就等于浏览器宽度；而在移动端不管是在什么设备上，html 设置100%，**基本上宽度都等于980px**。

### 3.1 布局视口

　　所以这就引出了布局视口的概念。宽度设置是根据布局视口来算的，只是PC端布局视口就等于浏览器宽度，而移动终端由于屏幕宽度较窄，为了显示在 PC 端网页显示的网页能在移动端基本能看，所以浏览器厂商一般将其设为 980px 然后进行缩放，让网页在窄屏幕上能够全部显示。布局视口尺寸可以通过如下代码获取：

```js
document.documentElement.clientWidth/Height;
```

　　虽然`document.documentElement`就是 html 元素，但是取值却不是取的 html 元素的宽度。同时我们做的媒体查询中判断的`max-width`也是判断布局视口的宽度。

```css
@media all and (max-width: 400px) {
	.box{
		width: 300px;
	}
}
```

### 3.2 视觉视口

　　视觉视口就是用户能够看到的窗口，单纯的用视觉去描述它就是浏览器屏幕的大小。用CSS像素去描述就是：**视觉视口的大小就是屏幕大小范围内CSS像素堆积的总面积，不管CSS像素是否缩放**。

- 移动端布局需要达到的效果： **设置布局视口的宽度正好等于屏幕的大小**。

```html
<!--设置布局视口等于device-width-->
<meta name="viewport" content="width=device-width">

<!-- 只设置缩放值也能将布局视口宽度设置为屏幕宽度，设置为0.5时由于CSS像素缩放了0.5，填到屏幕中的CSS像素数量正好是屏幕宽度 -->
<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

<!-- 这是兼容写法 -->
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1,user-scalable=no">
```

## 4. 移动适配方案总结

### 4.1 width=device-width

　　直接设置`width=device-width`，这样能够保证宽度一致，但考虑到苹果的Retina屏幕设计师出设计稿的时候都是放大了一倍设计稿，比如640px（基于iphone5）、750px（基于iphone6）。如果我们拿到的设计稿是750px宽，在设置缩放比为100%、布局视口等于屏幕宽度的情况下，我们拿到的设计稿宽度是大了一倍的，（网页中设置375px沾满屏幕，而设计稿切出的图是750px），所以在转换成网页的时候设置宽度需要将设计图的宽度除以2来，如果考虑到iphone6 plus的dpr为3，要保证在6 plus下图片还是高清，就需要将750px的设计稿再放大1.5倍，用@3倍图切出来。以上可以知道这种方案不需要动态的去根据屏幕dpr不同来设置meta标签内容，直接一句话搞定，然后需要调整的地方通过媒体查询来做。

### 4.2 flexible

　　淘宝的 flexible 方案只解决苹果设备上的 dpr 为2和3的情况，不考虑安卓设备也不考虑 pad。做的事情也很简单，就是动态设置 meta 标签的内容，和第一种方案不同的是没有设置为 `width=device-width`,而是通过设置 `initial-scale` 来缩放布局视口，dpr 为1，缩放为1；dpr 为2，缩放0.5；dpr 为3，缩放0.3333；通过这种方法使得布局视口在视觉上还是屏幕大小但CSS像素数量却增加了4倍/9倍。而这样的直接好处就是比如 iphone6 的视觉视口横向有了750个 CSS 像素点，和设计图保持一致了，同时CSS像素缩放 0.5 解决了经典的 1px 像素问题。

　　该方案的核心原理是通过`window.navigator.appVersion`判断是否是iphone，其他的比如ipad、Android直接设置dpr为1，然后通过 1/ dpr 得到缩放值。

```js
var isAndroid = win.navigator.appVersion.match(/android/gi);
/* 判断iphone ipad不考虑*/
var isIPhone = win.navigator.appVersion.match(/iphone/gi);
var devicePixelRatio = win.devicePixelRatio;
if (isIPhone) {
    // iOS下，对于2和3的屏，用2倍的方案，其余的用1倍方案
    if (devicePixelRatio >= 3 && (!dpr || dpr >= 3)) {                
        dpr = 3;
    } else if (devicePixelRatio >= 2 && (!dpr || dpr >= 2)){
        dpr = 2;
    } else {
        dpr = 1;
    }
} else {
    // 其他设备下，仍旧使用1倍的方案
    dpr = 1;
}
/*缩放值*/
scale = 1 / dpr;
```

　　这个解决方案中用的布局单位是**rem**而不是**px**，这也是为了等比例缩放的问题。rem单位代表的是根节点也就是 html 的 fontSize 的值，html默认为16px，所以默认1rem = 16px。既然开发的设计标注图是750px的，将 html 设为 75px 就很方便了，10rem = 750px。然后放到所有屏幕情况下：

```js
function refreshRem(){
    /*获取布局视口宽度,也可用document.documentElement.clientWidth*/
    var width = document.documentElement.getBoundingClientRect().width;

    /* 判断屏幕宽度，如果dpr为1且宽度>540 则恒定为540px，dpr为2如果宽度>1080则恒定为1080px*/

    if (width / dpr > 540) {
        width = 540 * dpr;
    }

    /*将布局视口宽度除以10得到html字体大小*/
    var rem = width / 10;
    document.documentElement.style.fontSize = rem + 'px';
```

　　比如iphone5的设备下布局视口是640，所以 html 的字体大小会设置为64px，而在开发的时候设置的单位为 rem,这个时候rem 自动根据 64px 转换，就实现了等比缩放。写 rem 的时候可以通过 CSSREM 插件来写，只是后期维护比较麻烦。

　　字体不用 rem 而采用 px 是因为我们希望一个文本字号不因为Retina显示屏的原因而缩放变小。然后在大屏上也不会放大而能够看到更多的文本。但是不同的dpr下又的确是要分别设置字号的。这个解决方案会在 htm l元素上设置 data-dpr 属性，然后通过该属性判断来设置字体大小。

```css
div.box{
    font-size: 12px;
}
[data-dpr="2"] div{
    font-size: 24px;
}
[data-dpr="3"] div{
    font-size: 36px;
} 
```

　　设计稿设计方面要求为 750px，如果设计师有做标注就做在这个稿子上，没有标注的话我们开发的时候就依据这个设计稿来量间距之类的。同时将这个稿子放大 1.5 倍来得到 1125px 的设计稿，切图用这份设计稿保证 dpr 为 3 的屏幕图片显示足够清晰。在 iphone6 的屏幕下开发然后再向上向下适配。

### 4.3 设置固宽

　　固定设置布局视口的宽度，比如设置为640，或750。

<hr>

　　移动端适配的原理很简单，各个项目在用的时候也能去选一个适合的方案。在 vw 和 vh 单位兼容性不够的时候，要做到设置的单位等比缩放只能用 rem。另外现在是不是有更好的适配方案不太清楚，本文主要是对现在我所知道的方案做一个总结。